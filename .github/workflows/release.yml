
name: Release and Deploy

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - '.github/**'

permissions:
  contents: write

jobs:
  test:
    name: Run Tests Before Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test --no-daemon --stacktrace

      - name: Build all modules
        run: ./gradlew build --no-daemon

  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    needs: test
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      should_release: ${{ steps.version.outputs.should_release }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          # í˜„ì¬ ë²„ì „ í™•ì¸
          CURRENT_VERSION=$(grep "version = " build.gradle.kts | sed 's/.*version = "\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"
          
          # ë§ˆì§€ë§‰ íƒœê·¸ í™•ì¸ (v ìˆëŠ” íƒœê·¸ì™€ ì—†ëŠ” íƒœê·¸ ëª¨ë‘ ê³ ë ¤)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          echo "Last tag: $LAST_TAG"
          
          # vê°€ ìˆë‹¤ë©´ ì œê±°
          LAST_VERSION=${LAST_TAG#v}
          echo "Last version (without v): $LAST_VERSION"
          
          if [[ "$CURRENT_VERSION" != "$LAST_VERSION" ]]; then
            echo "New version detected: $CURRENT_VERSION (last: $LAST_VERSION)"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "tag=$CURRENT_VERSION" >> $GITHUB_OUTPUT  # v ì œê±°!
          else
            echo "No version change detected"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: determine-version
    if: needs.determine-version.outputs.should_release == 'true'

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # ë§ˆì§€ë§‰ íƒœê·¸ë¶€í„°ì˜ ì»¤ë°‹ ë¡œê·¸ë¡œ ì²´ì¸ì§€ë¡œê·¸ ìƒì„±
          # v ìˆëŠ” íƒœê·¸ì™€ ì—†ëŠ” íƒœê·¸ ëª¨ë‘ ì²˜ë¦¬
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges --since="2 weeks ago" | head -20)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | head -20)
          fi
          
          # ì²´ì¸ì§€ë¡œê·¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Minor improvements and bug fixes"
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release and Tag
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.determine-version.outputs.tag }}  # v ì—†ëŠ” íƒœê·¸
          name: Release ${{ needs.determine-version.outputs.tag }}  # v ì—†ëŠ” ì´ë¦„
          body: |
            ## ğŸš€ What's New in ${{ needs.determine-version.outputs.tag }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ## ğŸ“¦ Installation
            
            ### Gradle (Kotlin DSL)
            ```kotlin
            repositories {
                maven("https://jitpack.io")
            }
            
            dependencies {
                // Spring Boot Starter (ê¶Œì¥)
                implementation("com.github.ckaanf.api-rate-limiter:rate-limiter-spring-boot-starter:${{ needs.determine-version.outputs.tag }}")
            
                // ë˜ëŠ” ê°œë³„ ëª¨ë“ˆ
                implementation("com.github.ckaanf.api-rate-limiter:rate-limiter-core:${{ needs.determine-version.outputs.tag }}")
                implementation("com.github.ckaanf.api-rate-limiter:rate-limiter-algorithm-token-bucket:${{ needs.determine-version.outputs.tag }}")
            }
            ```
            
            ### Gradle (Groovy)
            ```groovy
            repositories {
                maven { url 'https://jitpack.io' }
            }
            
            dependencies {
                implementation 'com.github.ckaanf.api-rate-limiter:rate-limiter-spring-boot-starter:${{ needs.determine-version.outputs.tag }}'
            }
            ```
            
            ### Maven
            ```xml
            <repositories>
                <repository>
                    <id>jitpack.io</id>
                    <url>https://jitpack.io</url>
                </repository>
            </repositories>
            
            <dependency>
                <groupId>com.github.ckaanf.api-rate-limiter</groupId>
                <artifactId>rate-limiter-spring-boot-starter</artifactId>
                <version>${{ needs.determine-version.outputs.tag }}</version>
            </dependency>
            ```
            
            ## ğŸ” JitPack Status
            
            ë¹Œë“œ ìƒíƒœ í™•ì¸: [JitPack Build Status](https://jitpack.io/#ckaanf/api-rate-limiter/${{ needs.determine-version.outputs.tag }})
            
            > **Note**: JitPack ë¹Œë“œëŠ” íƒœê·¸ ìƒì„± í›„ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤. ì²« ë²ˆì§¸ ì˜ì¡´ì„± ìš”ì²­ ì‹œ ë¹Œë“œê°€ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

  # JitPack ìƒíƒœ í™•ì¸
  check-jitpack:
    name: Check JitPack Build Status
    runs-on: ubuntu-latest
    needs: [ determine-version, create-release ]
    if: needs.determine-version.outputs.should_release == 'true'
    
    steps:
      - name: Wait for JitPack
        run: |
          echo "â³ JitPack ë¹Œë“œ ëŒ€ê¸° ì¤‘..."
          sleep 60

      - name: Check JitPack build status
        run: |
          VERSION="${{ needs.determine-version.outputs.tag }}"
          echo "ğŸ” JitPack ë¹Œë“œ ìƒíƒœ í™•ì¸: $VERSION"
          
          # JitPack APIë¡œ ë¹Œë“œ ìƒíƒœ í™•ì¸
          RESPONSE=$(curl -s "https://jitpack.io/api/builds/com.github.ckaanf/api-rate-limiter/$VERSION" || echo '{"status":"unknown"}')
          STATUS=$(echo "$RESPONSE" | jq -r '.status // "unknown"' 2>/dev/null || echo "unknown")
          
          echo "ğŸ“Š JitPack ë¹Œë“œ ìƒíƒœ: $STATUS"
          echo "ğŸ”— ë¹Œë“œ ë¡œê·¸: https://jitpack.io/com/github/ckaanf/api-rate-limiter/$VERSION/build.log"
          
          case "$STATUS" in
            "ok")
              echo "âœ… JitPack ë¹Œë“œ ì„±ê³µ!"
              ;;
            "building")
              echo "ğŸ”„ JitPack ë¹Œë“œ ì§„í–‰ ì¤‘..."
              ;;
            "error"|"fail")
              echo "âŒ JitPack ë¹Œë“œ ì‹¤íŒ¨"
              echo "ğŸ“‹ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”: https://jitpack.io/com/github/ckaanf/api-rate-limiter/$VERSION/build.log"
              exit 1
              ;;
            *)
              echo "â„¹ï¸  JitPack ë¹Œë“œ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”."
              echo "ğŸ”— https://jitpack.io/#ckaanf/api-rate-limiter/$VERSION"
              ;;
          esac

  # ë¦´ë¦¬ì¦ˆ ì•Œë¦¼
  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [ determine-version, create-release, check-jitpack ]
    if: always() && needs.determine-version.outputs.should_release == 'true'
    
    steps:
      - name: Create release summary
        run: |
          VERSION="${{ needs.determine-version.outputs.tag }}"
          JITPACK_STATUS="${{ needs.check-jitpack.result }}"
          
          echo "## ğŸ‰ Release $VERSION Published!"
          echo ""
          echo "**ğŸ“¦ GitHub Release:** [View Release](https://github.com/${{ github.repository }}/releases/tag/$VERSION)"
          echo ""
          echo "**ğŸš€ JitPack Status:** $([ "$JITPACK_STATUS" = "success" ] && echo "âœ… Ready" || echo "â³ Building")"
          echo ""
          echo "**ğŸ“– Usage:**"
          echo '```kotlin'
          echo "dependencies {"
          echo "    implementation(\"com.github.ckaanf.api-rate-limiter:rate-limiter-spring-boot-starter:$VERSION\")"
          echo "}"
          echo '```'
          echo ""
          echo "**ğŸ”— Links:**"
          echo "- [JitPack Page](https://jitpack.io/#ckaanf/api-rate-limiter/$VERSION)"
          echo "- [Documentation](https://github.com/${{ github.repository }}#readme)"